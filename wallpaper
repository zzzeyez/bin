#!/usr/bin/env bash
#
# author: daniel neemann (@zzzeyez)
#
# sets wallpaper from `wal` color number,
# image address or hex value
#
# requires `imagemagick`, `wal`

image="/tmp/wallpaper.png"
image2="/tmp/solidbg2.png"

help() {
	printf "available inputs: Wal color number, image address, directory, hex value \n"
	printf "so for example: \n"
	printf "wallpaper 8 \n"
	printf "wallpaper ./smiledog.jpg \n"
	printf "wallpaper ~/wallpapers/ \n"
	printf "wallpaper dddddd \n \n"
	printf "or you can save the current wallpaper: \n"
}

single() {
	path="$(cd "$(dirname "$1")"; pwd)/$(basename "$1")"
}

random() {
	dir="$1"
	n_files="$(/bin/ls -1 "$dir" | wc -l | cut -f1)"
	rand_num="$(awk "BEGIN{srand();print int($n_files * rand()) + 1;}")"
	file="$(/bin/ls -1 "$dir" | sed -ne "${rand_num}p")"
	path="$(cd $dir && echo "$PWD/$file")" # Converts to full path
}

walcolor() {
	source "${HOME}/.cache/wal/colors.sh"
	declare -n walcolor=color$1
	color="$walcolor"
	convert -size 5x5 xc:"$color" "$image"
#	notify-send -i "$image" -m "$color"
}

store() {
	if test -e $path -a $(file -b --mime-type $path) = "image/png"; then
		cp "$path" "$image"
	else
		convert "$path" "$image"
	fi
}

set_wallpaper() {
	METHOD=$(sw_vers -productVersion | awk -F'.' '{ if ($1 < 10 || $2 < 9) \
		{ print "osascript" } else{ print "sqlite3"  } }')
	case $METHOD in
        osascript)
		osascript -e "tell application \"Finder\" to set desktop picture \
			to POSIX file \"${1}\""
	;;
	sqlite3)
		current_path=$(sqlite3 -noheader -batch ${HOME}/Library/Application\ Support/Dock/desktoppicture.db 'select value from data limit 1')
		if [[ "$current_path" != "$1" ]]; then
			sqlite3 ${HOME}/Library/Application\ Support/Dock/desktoppicture.db \
				"update data set value = '${1}'" && killall Dock
		fi
	;;
	*)
		echo "error setting wallpaper" && exit 1
	;;
	esac
}

notify() {
	if [ -x "$notify" ] ; then
		if [[ "$path" ]] ; then
			notify-send -i "$path" -m "wallpaper set as $path"
		elif [[ "$color" ]] ; then
			notify-send -i "$image" -m "wallpaper set as $color"
		fi
	fi
}

flags() {
	while getopts nh opt; do
		case $opt in
			n)
			notify="$(which notify-send)"
			;;
			h)
			help
			exit
			;;
			x)
			rm "${HOME}/Library/Application\ Support/Dock/desktoppicture.db"
			exit
			;;
			*)
			help
			exit
			;;
		esac
	done
	# if no flags are provided do treat argument as file or directory
	shift "$((OPTIND-1))" 
	if [ "$1" != "-*" ] && [ "$1" ] ; then
		case "$1" in
		[0-9]) walcolor "$1" ;;
		*.*) single "$1" ;;
		*) random "$1" ;;
		esac
	fi
}

if [ "$#" -ne 0 ]; then
	flags "$@"
	# osascript does not allow you to repeatedly set as same image
	# so we generate an additional image
	if [[ -z "$path" ]] ; then
		if [[ -f "$image2" ]] ; then
			convert -size 5x5 xc:"#aaaaaa" "$image2"
		fi
		notify & set_wallpaper "$image2"
		set_wallpaper "$image"
	else
		notify & set_wallpaper "$path" & store
	fi
else
	help
	exit
fi
